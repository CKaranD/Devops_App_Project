FROM public.ecr.aws/lambda/python:3.8

# lambda_conversation_bot_vecdb.py

# ================== Do this section only if having trouble with hnswlib / annoy
RUN yum update -y && \
    yum install -y python-setuptools python-pip git && \    
    yum clean all

# Install development tools and Python3 development headers
RUN yum install -y python3-devel

# Install essential build tools
RUN yum groupinstall -y "Development Tools"

#### ==== use the following for hnsw ==================================
# # Clone the repository and install the Python package
# RUN git clone https://github.com/nmslib/hnswlib.git /hnswlib && \
#     cd /hnswlib && \
#     pip install .
# ================== END OF hnswlib ===================================

#### ==== use the following for annoy ==================================
RUN pip install annoy
# ================== END OF annoy ===================================

# Set the working directory (mostly not needed)
# WORKDIR /hnswlib

COPY requirements.txt  .
RUN pip3 install -r requirements.txt --target "${LAMBDA_TASK_ROOT}"

# Copy function code
COPY lambda_conversation_bot_vecdb.py ${LAMBDA_TASK_ROOT}
COPY zusbot_main_no_tools.py ${LAMBDA_TASK_ROOT}
COPY detect_language.py ${LAMBDA_TASK_ROOT}
COPY get_openai_key.py ${LAMBDA_TASK_ROOT}
COPY query_annoydb_memory.py ${LAMBDA_TASK_ROOT}
COPY zus_write_load_mem.py ${LAMBDA_TASK_ROOT}
COPY template_main_v4.py ${LAMBDA_TASK_ROOT}

# Copy DB
COPY db "${LAMBDA_TASK_ROOT}/db"

# Copy API keys from folders
COPY AWS_S3_KEY/AWS_S3_KEY.txt ${LAMBDA_TASK_ROOT}
COPY OPENAI_API_KEY/OPENAI_API_KEY_MINDHIVE.txt ${LAMBDA_TASK_ROOT}

# Set the CMD to your handler (could also be done as a parameter override outside of the Dockerfile)
CMD [ "lambda_conversation_bot_vecdb.lambda_conversation_bot_vecdb" ]